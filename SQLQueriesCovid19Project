/*
Covid 19 Data Exploration 
Skills used: Joins, CTE's, Temp Tables, Aggregate Functions, Creating Temporary Tables, Creating Views, Converting Data Types
*/

--Previewing CovidDeaths data
SELECT location, date, total_cases, new_cases, total_deaths, population
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Order by 1, 2

--1. Query for Tableau Project
--Global Numbers
--Total Cases, Total Deaths, and Average Death Percentage Across the World
SELECT SUM(new_cases) as total_cases, SUM(cast(new_deaths as int)) as total_deaths, SUM(cast(new_deaths as int)) / SUM(new_cases)*100 as death_percentage_global
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Order by 1, 2

-- 2. Query for Tableau Project
--Total Death Count Per Continent 
-- Take these out as they are not included in the above queries and want to stay consistent
-- European Union is part of Europe
-- Income counted twice, put under location column
Select location, SUM(cast(new_deaths as int)) as total_deaths
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is null 
and location not in ('World', 'European Union', 'International', 'Lower middle income', 'Low income', 'High income', 'Upper middle income')
Group by location
Order by total_deaths desc

-- 3. Query for Tableau Project
--Total Infection by Country
--Looking at Countries with Highest Infection Rate Compared to Population 
Select location, population, Max(total_cases) as highest_infection_count, Max((total_cases/population))*100 as percent_population_infected
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where location not in ('World', 'European Union', 'International', 'Lower middle income', 'Low income', 'High income', 'Upper middle income')
Group by location, population
Order by percent_population_infected desc

-- 4. Query for Tableau Project
-- Percent Population Infected
--Filter popular countries
SELECT Location, Population, date, MAX(total_cases) as highest_infection_count,  Max((total_cases/population))*100 as percent_population_infected
FROM `portfolioproject-360018.Covid.CovidDeaths` 
WHERE Location in ('United States', 'United Kingdom', 'China', 'Russia', 'Canada', 'Mexico', 'India')
GROUP BY Location, Population, date
ORDER BY percent_population_infected desc;

-- 5. Query for Tableau Project
-- Percent Population Vaccinated 
--Total Vaccinations by Country
--Looking at Countries with Highest Vaccination Rate Compared to Population 
Select location, population, Max(total_cases) as highest_infection_count, Max((total_cases/population))*100 as percent_population_infected
FROM `portfolioproject-360018.Covid.CovidVaccinations` 
Where location not in ('World', 'European Union', 'International', 'Lower middle income', 'Low income', 'High income', 'Upper middle income')
Group by location, population
Order by percent_population_infected desc

Select continent, location, date, population, new_vaccinations, SUM(CAST(new_vaccinations as int)) OVER (PARTITION BY location ORDER BY location, date) as accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidVaccinations` 
Where continent is not null
Order by 2, 3

With PopVsVac 
as 
(
Select dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(CAST(vac.new_vaccinations as int)) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) as accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
  on dea.location = vac.location 
  and dea.date = vac.date 
Where dea.continent is not null
) 
Select *, (accum_vaccinations/Population)*100 as vaccinated_percentage_country_population
From PopVsVac


-- 6. Query for Tableau Project
--Total Death Vaccination Count Per Continent 
-- Take these out as they are not included in the above queries and want to stay consistent
-- European Union is part of Europe
-- Income counted twice, put under location column
Select location, population, SUM(total_vaccinations) as vaccination_count, 
  (
    SELECT 
      SUM((total_vaccinations)/population) OVER (PARTITION BY location ORDER BY location, population)) as vaccination_percentage 
    FROM `portfolioproject-360018.Covid.CovidVaccinations` 
  )
FROM `portfolioproject-360018.Covid.CovidVaccinations` 
Where continent is null 
and location not in ('World', 'European Union', 'International', 'Lower middle income', 'Low income', 'High income', 'Upper middle income')
Group by location, population
Order by vaccination_count desc


--All countries
Select Location, Population, date, MAX(total_cases) as highest_infection_count,  Max((total_cases/population))*100 as percent_population_infected
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Group by Location, Population, date
order by percent_population_infected desc


--All countries, filter out World, EU, Int., income
Select Location, Population, date, MAX(total_cases) as highest_infection_count,  Max((total_cases/population))*100 as percent_population_infected
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where location not in ('World', 'European Union', 'International', 'Lower middle income', 'Low income', 'High income', 'Upper middle income')
Group by Location, Population, date
order by percent_population_infected desc

-- Looking at Total Cases vs Total Deaths 
-- Calculate Percentage of People Dying Who Report Being Infected
--Shows likelihood of dying if you contract Covid in your country
SELECT location, date, total_cases, new_cases, total_deaths, (total_deaths/total_cases)*100 as death_cases_percentage, 
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null

--Looking at Total Cases vs Population
--Shows what percentage of population has reported Covid
--Sorted by most recent date first
SELECT location, date, population, total_cases, (total_cases/population)*100 as cases_population_percentage, 
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Order by date desc 

--Total Deaths vs Population
SELECT location, date, population, total_cases, total_deaths, (total_deaths/total_cases)*100 as death_cases_percentage, (total_deaths/population)*100 as death_population_percentage
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Order by date desc 


--Showing Countries with Highest Death Count Per Population
--Convert total_deaths data type from char to integer using CAST funtion
Select location, Max(cast(total_deaths as int)) as total_death_count
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Group by location
Order by total_death_count desc

--LET'S BREAK THINGS DOWN BY CONTINENT 

--Showing Continents with the Highest Death Count per Population
Select continent, Max(cast(total_deaths as int)) as total_death_count
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Group by continent
Order by total_death_count desc

--Global Numbers

SELECT SUM(new_cases) as total_cases, SUM(cast(new_deaths as int)) as total_deaths, SUM(cast(new_deaths as int)) / SUM(new_cases)*100 as death_percentage_global
FROM `portfolioproject-360018.Covid.CovidDeaths` 
Where continent is not null
Group by date
Order by 1, 2

-- Join CovidDeaths and Covid Vaccinations Tables

Select*
FROM `portfolioproject-360018.Covid.CovidDeaths` as dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations`  as vac
  on dea.location = vac.location 
  and dea.date = vac.date 

--Looking at Total Population vs. Vaccinations
--Convert new_vaccinations data type from char to integer using CAST funtion
--Create temp table to find percentage of population vaccinated
Select dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(CAST(vac.new_vaccinations as int)) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) as accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
  on dea.location = vac.location 
  and dea.date = vac.date 
Where dea.continent is not null
Order by 2, 3

-- Using CTE to Perform Calculations on Partition By in Previous Query
--Percentage of Vaccinatated Population by Country 
With PopVsVac 
as 
(
Select dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(CAST(vac.new_vaccinations as int)) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) as accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
  on dea.location = vac.location 
  and dea.date = vac.date 
Where dea.continent is not null
) 
Select *, (accum_vaccinations/Population)*100 as vaccinated_percentage_country_population
From PopVsVac


---Maximum Vaccinated Percentages of Population by Country 
With PopVsVac 
as 
(
Select dea.continent, dea.location, dea.date, dea.population, vac.new_vaccinations, SUM(CAST(vac.new_vaccinations as int)) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) as accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
  on dea.location = vac.location 
  and dea.date = vac.date 
Where dea.continent is not null
) 
Select *, (accum_vaccinations/Population)*100 as vaccinated_percentage_country_population
From PopVsVac

-- Create Temp Table to Perform Calculations on Partition By in Previous Query

DROP Table if exists PercentPopulationVaccinated
CREATE TEMP TABLE PercentPopulationVaccinated
(
      continent string,
      location string,
      date datetime,
      population int64,
      new_vaccinations int64,
      Accum_Vaccinations int64
);

INSERT INTO PercentPopulationVaccinated
SELECT dea.continent, dea.location, dea.date, dea.population,vac.new_vaccinations
, SUM(vac.new_vaccinations) OVER (PARTITION BY dea.location ORDER BY dea.location,dea.date) AS Accum_Vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
      ON dea.location = vac.location
      AND dea.date = vac.date
WHERE dea.continent IS NOT NULL;

SELECT *, (Accum_Vaccinations/population)*100
FROM PercentPopulationVaccinated;


---Create View to Store Data for Later Visualizations

CREATE VIEW portfolioproject-360018.Covid.PercentPopulationVaccinated as
SELECT dea.continent, dea.location, dea.date, dea.population,vac.new_vaccinations, SUM(CAST(vac.new_vaccinations as int)) OVER (PARTITION BY dea.location ORDER BY dea.location, dea.date) AS accum_vaccinations
FROM `portfolioproject-360018.Covid.CovidDeaths` dea
JOIN `portfolioproject-360018.Covid.CovidVaccinations` vac
      ON dea.location = vac.location
      AND dea.date = vac.date
WHERE dea.continent IS NOT NULL 

--Queries and Visualizations for later:
--A. percent of global populationtion 1. recieved one dose, 2. fully vaccinated, 3. additional dose
--stacked horizontal bar chart
--B. Share of population  1. recieved one dose, 2. fully vaccinated, 3. additional dose
--Global map, color=percent of dose

